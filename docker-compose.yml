# ============================================================================
# Docker Compose Configuration - Compatible with deploy-manual.sh
# ============================================================================
# This configuration mirrors the working setup from deploy-manual.sh
# Key features:
# - Uses external network "ai-chatbot-network"
# - Redis hostname: "redis-server" (not "redis")
# - MongoDB with authentication
# - All volume mounts and environment variables match docker run setup
# ============================================================================

services:
  # ============================================================================
  # AI Chatbot Service (Main Application)
  # ============================================================================
  ai-chatbot-rag:
    container_name: ai-chatbot-rag
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    env_file:
      - .env
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-8000}:8000"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./chat_history.db:/app/chat_history.db
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
      # Mount credentials file from production server directory (not from repo)
      - /home/hoile/wordai/wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
      - VERTEX_AI_REGION=asia-southeast1

      # AI API Keys
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_KEY2=${GEMINI_API_KEY2}
      - VERTEX_API_KEY=${VERTEX_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - CHATGPT_API_KEY=${CHATGPT_API_KEY}
      - CHATGPT_MODEL=${CHATGPT_MODEL:-gpt-4o}
      - CEREBRAS_API_KEY=${CEREBRAS_API_KEY}
      - CEREBRAS_MODEL=${CEREBRAS_MODEL}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=${CLAUDE_MODEL}
      - CLAUDE_SONNET_MODEL=${CLAUDE_SONNET_MODEL}
      - DEFAULT_AI_PROVIDER=${DEFAULT_AI_PROVIDER:-cerebras}

      # Firebase Configuration
      - FIREBASE_CREDENTIALS_FILE=${FIREBASE_CREDENTIALS_FILE}
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_DATABASE_URL=${FIREBASE_DATABASE_URL}
      - FIREBASE_PRIVATE_KEY_ID=${FIREBASE_PRIVATE_KEY_ID}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
      - FIREBASE_CLIENT_ID=${FIREBASE_CLIENT_ID}
      - FIREBASE_CLIENT_CERT_URL=${FIREBASE_CLIENT_CERT_URL}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      - FIREBASE_SERVICE_ACCOUNT_PATH=${FIREBASE_SERVICE_ACCOUNT_PATH}

      # Cloudflare R2 Storage
      - R2_API_TOKEN=${R2_API_TOKEN}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_REGION=${R2_REGION:-auto}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}

      # AIvungtau R2 Storage
      - AIVUNGTAU_R2_ACCESS_KEY_ID=${AIVUNGTAU_R2_ACCESS_KEY_ID}
      - AIVUNGTAU_R2_SECRET_ACCESS_KEY=${AIVUNGTAU_R2_SECRET_ACCESS_KEY}
      - AIVUNGTAU_R2_BUCKET_NAME=${AIVUNGTAU_R2_BUCKET_NAME}
      - AIVUNGTAU_R2_ENDPOINT=${AIVUNGTAU_R2_ENDPOINT}
      - AIVUNGTAU_R2_PUBLIC_URL=${AIVUNGTAU_R2_PUBLIC_URL}
      - AIVUNGTAU_R2_STATIC_DOMAIN=${AIVUNGTAU_R2_STATIC_DOMAIN}

      # Qdrant Vector Database
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - VECTOR_SIZE=${VECTOR_SIZE:-768}

      # Domain Configuration
      - DOMAIN=${DOMAIN}
      - BASE_URL=${BASE_URL}
      - BACKEND_WEBHOOK_URL=${BACKEND_WEBHOOK_URL}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - CORS_ORIGINS=${CORS_ORIGINS}

      # Email Service (Brevo)
      - BREVO_API_KEY=${BREVO_API_KEY}
      - BREVO_SMTP_SERVER=${BREVO_SMTP_SERVER}
      - BREVO_SMTP_PORT=${BREVO_SMTP_PORT}
      - BREVO_SMTP_LOGIN=${BREVO_SMTP_LOGIN}
      - BREVO_SENDER_EMAIL=${BREVO_SENDER_EMAIL}
      - BREVO_SENDER_NAME=${BREVO_SENDER_NAME}

      # Payment Service
      - SEPAY_SECRET_KEY=${SEPAY_SECRET_KEY}
      - SEPAY_API_URL=${SEPAY_API_URL}
      - SEPAY_SANDBOX=${SEPAY_SANDBOX}
      - SEPAY_API_MERCHANT_ID=${SEPAY_API_MERCHANT_ID}
      - IPN_URL=${IPN_URL}
      - API_SECRET_KEY=${API_SECRET_KEY}
      - SERVICE_SECRET=${SERVICE_SECRET}

      # Crypto Wallet
      - WORDAI_BEP20_ADDRESS=${WORDAI_BEP20_ADDRESS}
      - USDT_CONTRACT_ADDRESS=${USDT_CONTRACT_ADDRESS}
      - ETHERSCAN_API_KEY=${ETHERSCAN_API_KEY}

      # Other APIs
      - SERPAPI_KEY=${SERPAPI_KEY}

      - USE_MOCK_EMBEDDING=${USE_MOCK_EMBEDDING:-false}

      # Redis Configuration (matching deploy-manual.sh)
      - REDIS_URL=redis://redis-server:6379
      - REDIS_HOST=redis-server
      - REDIS_PORT=6379

      # Redis Cache for Community Books
      - REDIS_CACHE_URL=redis://redis-community-book:6379
      - REDIS_CACHE_HOST=redis-community-book
      - REDIS_CACHE_PORT=6379

      # MongoDB Configuration (with authentication)
      - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
      - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
      - MONGODB_ROOT_USERNAME=${MONGODB_ROOT_USERNAME}
      - MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGODB_APP_USERNAME=${MONGODB_APP_USERNAME}
      - MONGODB_APP_PASSWORD=${MONGODB_APP_PASSWORD}

      # Other settings
      - DATA_DIR=/app/data
    depends_on:
      - mongodb
      - redis-server
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-2G} # Reduced from 6G due to OOM (8GB server total)
          cpus: ${CPU_LIMIT:-2}

  # ============================================================================
  # AI Editor Worker - Format/Edit/Bilingual operations
  # ============================================================================
  ai-editor-worker:
    container_name: ai-editor-worker
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    command: python -m src.workers.ai_editor_worker
    volumes:
      - ./logs:/app/logs
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
      - ./wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - REDIS_URL=redis://redis-server:6379
      - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
      - VERTEX_AI_REGION=asia-southeast1
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_SONNET_MODEL=${CLAUDE_SONNET_MODEL}
    depends_on:
      - redis-server
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    deploy:
      resources:
        limits:
          memory: 2G # Increased from 1G - PDF processing needs more RAM for large files
          cpus: "1"
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep 'ai_editor_worker' | grep -v grep || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Slide Format Worker - AI slide layout optimization
  # ============================================================================
  slide-format-worker:
    container_name: slide-format-worker
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    command: python -m src.workers.slide_format_worker
    volumes:
      - ./logs:/app/logs
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
      - ./wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - REDIS_URL=redis://redis-server:6379
      - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
      - VERTEX_AI_REGION=asia-southeast1
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_SONNET_MODEL=${CLAUDE_SONNET_MODEL}
    depends_on:
      - redis-server
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    deploy:
      resources:
        limits:
          memory: 512M # Reduced from 1G - RAM optimization
          cpus: "1"
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep 'slide_format_worker' | grep -v grep || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Chapter Translation Worker - Book chapter translation
  # ============================================================================
  chapter-translation-worker:
    container_name: chapter-translation-worker
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    command: python -m src.workers.chapter_translation_worker
    volumes:
      - ./logs:/app/logs
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - REDIS_URL=redis://redis-server:6379
      - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
      - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_KEY2=${GEMINI_API_KEY2}
    depends_on:
      - redis-server
      - mongodb
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    deploy:
      resources:
        limits:
          memory: 512M # Reduced from 1G - RAM optimization
          cpus: "1"
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep 'chapter_translation_worker' | grep -v grep || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Test Generation Worker - AI test generation (listening, grammar, vocab)
  # ============================================================================
  test-generation-worker:
    container_name: test-generation-worker
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    command: python -m src.workers.test_generation_worker
    volumes:
      - ./logs:/app/logs
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
      - ./wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - REDIS_URL=redis://redis-server:6379
      - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
      - VERTEX_AI_REGION=asia-southeast1
      - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
      - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_KEY2=${GEMINI_API_KEY2}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
    depends_on:
      - redis-server
      - mongodb
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    deploy:
      resources:
        limits:
          memory: 512M # Reduced from 2G - RAM optimization
          cpus: "1"
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep 'test_generation_worker' | grep -v grep || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Slide Generation Worker - AI slide creation from analysis
  # ============================================================================
  slide-generation-worker:
    container_name: slide-generation-worker
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    command: python -m src.workers.slide_generation_worker
    volumes:
      - ./logs:/app/logs
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
      - ./wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - REDIS_URL=redis://redis-server:6379
      - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
      - VERTEX_AI_REGION=asia-southeast1
      - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
      - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_KEY2=${GEMINI_API_KEY2}
      - CEREBRAS_API_KEY=${CEREBRAS_API_KEY}
      - CEREBRAS_MODEL=${CEREBRAS_MODEL}
    depends_on:
      - redis-server
      - mongodb
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    deploy:
      resources:
        limits:
          memory: 512M # Reduced from 2G - RAM optimization
          cpus: "1"
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep 'slide_generation_worker' | grep -v grep || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Slide Narration Subtitle Worker - AI subtitle generation
  # ============================================================================
  slide-narration-subtitle-worker:
    container_name: slide-narration-subtitle-worker
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    env_file:
      - .env
    command: python -m src.workers.slide_narration_subtitle_worker
    volumes:
      - ./logs:/app/logs
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
      # Mount Vertex AI credentials for Gemini subtitle generation
      - /home/hoile/wordai/wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - REDIS_URL=redis://redis-server:6379
      - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
      - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_KEY2=${GEMINI_API_KEY2}
    depends_on:
      - redis-server
      - mongodb
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    deploy:
      resources:
        limits:
          memory: 512M # Reduced from 2G - RAM optimization
          cpus: "1"
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep 'slide_narration_subtitle_worker' | grep -v grep || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # PDF Chapter Worker - Convert large PDF files to book chapters
  # ============================================================================
  pdf-chapter-worker:
    container_name: pdf-chapter-worker
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    env_file:
      - .env
    command: python -m src.workers.pdf_chapter_worker
    volumes:
      - ./logs:/app/logs
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - REDIS_URL=redis://redis-server:6379
      - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
      - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-wordai}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL:-https://static.wordai.pro}
      - CLOUDFLARE_IMAGES_ENABLED=${CLOUDFLARE_IMAGES_ENABLED:-false}
      - CLOUDFLARE_IMAGES_ACCOUNT_ID=${CLOUDFLARE_IMAGES_ACCOUNT_ID:-}
      - CLOUDFLARE_IMAGES_API_TOKEN=${CLOUDFLARE_IMAGES_API_TOKEN:-}
      - CLOUDFLARE_IMAGES_ACCOUNT_HASH=${CLOUDFLARE_IMAGES_ACCOUNT_HASH:-}
      - CLOUDFLARE_IMAGES_DELIVERY_URL=${CLOUDFLARE_IMAGES_DELIVERY_URL:-}
    depends_on:
      - redis-server
      - mongodb
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    deploy:
      resources:
        limits:
          memory: 2G # Increased from 1G - PDF processing needs 2GB for large files (200+ pages)
          cpus: "2" # More CPU for image conversion
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep 'src.workers.pdf_chapter_worker' | grep -v grep || exit 1" ]
      interval: 30s
      timeout: 30s # Increased from 10s - ps aux can be slow during heavy PDF processing
      retries: 3
      start_period: 60s # Give worker time to initialize

  # ============================================================================
  # Lyria Music Generation Worker - AI music from text prompts
  # ============================================================================
  # ============================================================================
  # Lyria Music Worker - AI Music Generation (TEMPORARILY DISABLED)
  # ============================================================================
  # lyria-music-worker:
  #   container_name: lyria-music-worker
  #   image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
  #   env_file:
  #     - .env
  #   command: python -m src.workers.lyria_worker
  #   volumes:
  #     - ./logs:/app/logs
  #     - ./firebase-credentials.json:/app/firebase-credentials.json:ro
  #     # Mount Vertex AI credentials for Lyria API
  #     - /home/hoile/wordai/wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
  #   environment:
  #     - TZ=Asia/Ho_Chi_Minh
  #     - PYTHONPATH=/app
  #     - PYTHONUNBUFFERED=1
  #     - ENVIRONMENT=${ENVIRONMENT:-production}
  #     - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
  #     - VERTEX_AI_REGION=asia-southeast1
  #     - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
  #     - REDIS_URL=redis://redis-server:6379
  #     - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
  #     - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
  #     - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
  #     - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
  #     - R2_BUCKET_NAME=${R2_BUCKET_NAME}
  #     - R2_ENDPOINT=${R2_ENDPOINT}
  #     - R2_PUBLIC_URL=${R2_PUBLIC_URL}
  #   depends_on:
  #     - redis-server
  #     - mongodb
  #   restart: unless-stopped
  #   networks:
  #     - ai-chatbot-network
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 512M # Reduced from 2G - RAM optimization
  #         cpus: "1"
  #   healthcheck:
  #     test: [ "CMD", "python", "-c", "import sys; sys.exit(0)" ]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 10s

  # ============================================================================
  # Software Lab AI Workers - Code assistant features (TEMPORARILY DISABLED)
  # ============================================================================

  # Generate Code Worker - Creates complete code from natural language
  # generate-code-worker:
  #   container_name: generate-code-worker
  #   image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
  #   env_file:
  #     - .env
  #   command: python -m src.workers.generate_code_worker
  #   volumes:
  #     - ./logs:/app/logs
  #     - ./firebase-credentials.json:/app/firebase-credentials.json:ro
  #     - /home/hoile/wordai/wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
  #   environment:
  #     - TZ=Asia/Ho_Chi_Minh
  #     - PYTHONPATH=/app
  #     - PYTHONUNBUFFERED=1
  #     - ENVIRONMENT=${ENVIRONMENT:-production}
  #     - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
  #     - VERTEX_AI_REGION=asia-southeast1
  #     - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
  #     - REDIS_URL=redis://redis-server:6379
  #     - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
  #     - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
  #   depends_on:
  #     - redis-server
  #     - mongodb
  #   restart: unless-stopped
  #   networks:
  #     - ai-chatbot-network
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 512M # Reduced from 2G - RAM optimization
  #         cpus: "1"
  #   healthcheck:
  #     test: [ "CMD-SHELL", "ps aux | grep 'generate_code_worker' | grep -v grep || exit 1" ]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # Explain Code Worker - Adds inline educational comments
  # explain-code-worker:
  #   container_name: explain-code-worker
  #   image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
  #   env_file:
  #     - .env
  #   command: python -m src.workers.explain_code_worker
  #   volumes:
  #     - ./logs:/app/logs
  #     - ./firebase-credentials.json:/app/firebase-credentials.json:ro
  #     - /home/hoile/wordai/wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
  #   environment:
  #     - TZ=Asia/Ho_Chi_Minh
  #     - PYTHONPATH=/app
  #     - PYTHONUNBUFFERED=1
  #     - ENVIRONMENT=${ENVIRONMENT:-production}
  #     - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
  #     - VERTEX_AI_REGION=asia-southeast1
  #     - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
  #     - REDIS_URL=redis://redis-server:6379
  #     - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
  #     - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
  #   depends_on:
  #     - redis-server
  #     - mongodb
  #   restart: unless-stopped
  #   networks:
  #     - ai-chatbot-network
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 512M # Reduced from 2G - RAM optimization
  #         cpus: "1"
  #   healthcheck:
  #     test: [ "CMD-SHELL", "ps aux | grep 'explain_code_worker' | grep -v grep || exit 1" ]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # Transform Code Worker - Refactor/optimize/convert code
  # transform-code-worker:
  #   container_name: transform-code-worker
  #   image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
  #   env_file:
  #     - .env
  #   command: python -m src.workers.transform_code_worker
  #   volumes:
  #     - ./logs:/app/logs
  #     - ./firebase-credentials.json:/app/firebase-credentials.json:ro
  #     - /home/hoile/wordai/wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
  #   environment:
  #     - TZ=Asia/Ho_Chi_Minh
  #     - PYTHONPATH=/app
  #     - PYTHONUNBUFFERED=1
  #     - ENVIRONMENT=${ENVIRONMENT:-production}
  #     - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
  #     - VERTEX_AI_REGION=asia-southeast1
  #     - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
  #     - REDIS_URL=redis://redis-server:6379
  #     - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
  #     - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
  #   depends_on:
  #     - redis-server
  #     - mongodb
  #   restart: unless-stopped
  #   networks:
  #     - ai-chatbot-network
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 512M # Reduced from 2G - RAM optimization
  #         cpus: "1"
  #   healthcheck:
  #     test: [ "CMD-SHELL", "ps aux | grep 'transform_code_worker' | grep -v grep || exit 1" ]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # Gemini AI Worker - Combined Architecture Analysis + Project Scaffolding (using Gemini 3 Pro)
  gemini-ai-worker:
    container_name: gemini-ai-worker
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    env_file:
      - .env
    command: python -m src.workers.gemini_ai_worker
    volumes:
      - ./logs:/app/logs
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
      - /home/hoile/wordai/wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
      - VERTEX_AI_REGION=asia-southeast1
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - REDIS_URL=redis://redis-server:6379
      - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
      - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
    depends_on:
      - redis-server
      - mongodb
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    deploy:
      resources:
        limits:
          memory: 512M # Reduced from 2G - RAM optimization
          cpus: "1"
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep 'gemini_ai_worker' | grep -v grep || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Slide Narration Audio Worker - TTS audio generation
  # ============================================================================
  slide-narration-audio-worker:
    container_name: slide-narration-audio-worker
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    env_file:
      - .env
    command: python -m src.workers.slide_narration_audio_worker
    volumes:
      - ./logs:/app/logs
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
      # Mount Vertex AI credentials for TTS generation
      - /home/hoile/wordai/wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - REDIS_URL=redis://redis-server:6379
      - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
      - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_KEY2=${GEMINI_API_KEY2}
    depends_on:
      - redis-server
      - mongodb
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    deploy:
      resources:
        limits:
          memory: 512M # Reduced from 2G - RAM optimization
          cpus: "1"
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep 'slide_narration_audio_worker' | grep -v grep || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # MongoDB with Authentication (matching deploy-manual.sh)
  # ============================================================================
  mongodb:
    container_name: mongodb
    image: mongo:7.0
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - MONGO_INITDB_ROOT_USERNAME=${MONGODB_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=${MONGODB_NAME:-ai_service_db}
    restart: unless-stopped
    networks:
      - ai-chatbot-network

  # ============================================================================
  # Redis with Production Configuration (matching deploy-manual.sh)
  # Container name: redis-server (not "redis"!)
  # Used for: Job queue (test generation, slide narration, etc.)
  # ============================================================================
  redis-server:
    container_name: redis-server
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: >
      redis-server --appendonly yes --save 900 1 --save 300 10 --save 60 10000 --tcp-keepalive 300 --timeout 0 --maxmemory-policy allkeys-lru --replica-read-only no --replica-serve-stale-data yes --repl-diskless-sync no --repl-diskless-load disabled --protected-mode no --bind 0.0.0.0
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Redis Community Books Cache
  # Separate container for caching community books data
  # ============================================================================
  redis-community-book:
    container_name: redis-community-book
    image: redis:7-alpine
    ports:
      - "6380:6379" # External port 6380, internal 6379
    restart: unless-stopped
    command: >
      redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --save "" --appendonly no --tcp-keepalive 300 --timeout 0 --protected-mode no --bind 0.0.0.0
    networks:
      - ai-chatbot-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ============================================================================
  # Payment Service (Node.js) - SePay Integration
  # ============================================================================
  payment-service:
    container_name: payment-service
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-payment-service:${IMAGE_TAG:-latest}
    build:
      context: ./payment-service # CHỈ build từ folder payment-service/
      dockerfile: Dockerfile
    ports:
      - "3000:3000" # Internal only, NGINX will proxy
    volumes:
      - ./payment-service/logs:/app/logs # Log persistence
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro # Firebase credentials
    environment:
      # Server
      - TZ=Asia/Ho_Chi_Minh
      - NODE_ENV=production
      - PORT=3000
      - SERVICE_NAME=wordai-payment-service
      - FIREBASE_CREDENTIALS_PATH=/app/firebase-credentials.json

      # SePay Configuration (only 2 fields needed)
      - SEPAY_API_MERCHANT_ID=${SEPAY_API_MERCHANT_ID}
      - SEPAY_SECRET_KEY=${SEPAY_SECRET_KEY}
      - SEPAY_API_URL=${SEPAY_API_URL:-https://pgapi.sepay.vn}
      - SEPAY_CHECKOUT_URL=${SEPAY_CHECKOUT_URL:-https://pay.sepay.vn/v1/checkout/init}
      - SEPAY_SANDBOX=${SEPAY_SANDBOX:-false}

      # MongoDB (shared with Python service)
      - MONGODB_URI=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017
      - MONGODB_DATABASE=${MONGODB_NAME:-ai_service_db}

      # Python Service URL (internal Docker network)
      - PYTHON_SERVICE_URL=http://ai-chatbot-rag:8000

      # Webhook Configuration
      - WEBHOOK_URL=https://ai.wordai.pro/api/v1/webhooks/sepay
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}

      # Security
      - API_SECRET_KEY=${API_SECRET_KEY}
      - ALLOWED_ORIGINS=https://ai.wordai.pro,https://www.wordai.pro

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FILE=/app/logs/payment-service.log

      # Rate Limiting
      - RATE_LIMIT_WINDOW_MS=900000
      - RATE_LIMIT_MAX_REQUESTS=100
    depends_on:
      - mongodb
      - ai-chatbot-rag
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

  # ============================================================================
  # Video Export Worker - Playwright screenshot + FFmpeg encoding
  # ============================================================================
  video-export-worker:
    container_name: video-export-worker
    image: ${DOCKER_HUB_USERNAME:-lekompozer}/wordai-aiservice:${IMAGE_TAG:-latest}
    command: python -m src.workers.video_export_worker
    volumes:
      - ./logs:/app/logs
      - ./firebase-credentials.json:/app/firebase-credentials.json:ro
      - /home/hoile/wordai/wordai-6779e-ed6189c466f1.json:/app/wordai-6779e-ed6189c466f1.json:ro
    environment:
      - TZ=Asia/Ho_Chi_Minh
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - REDIS_URL=redis://redis-server:6379
      - GOOGLE_APPLICATION_CREDENTIALS=/app/wordai-6779e-ed6189c466f1.json
      - VERTEX_AI_REGION=asia-southeast1

      # MongoDB (read-only: presentation/subtitle/audio data, NOT for job status)
      - MONGODB_URI_AUTH=mongodb://${MONGODB_APP_USERNAME}:${MONGODB_APP_PASSWORD}@mongodb:27017/${MONGODB_NAME}?authSource=admin
      - MONGODB_NAME=${MONGODB_NAME:-ai_service_db}

      # R2 Storage (for video upload)
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_ENDPOINT=${R2_ENDPOINT}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}

      # Frontend URL (for Playwright screenshot)
      - FRONTEND_URL=${FRONTEND_URL:-https://wordai.pro}
    depends_on:
      - mongodb
      - redis-server
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    healthcheck:
      test: [ "CMD-SHELL", "ps aux | grep 'video_export_worker' | grep -v grep || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M # Reduced from 2G - RAM optimization (8GB server total)
          cpus: "1.5"

  # ============================================================================
  # NGINX - API Gateway and Reverse Proxy
  # ============================================================================
  nginx:
    container_name: nginx-gateway
    image: nginx:1.26-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro # SSL certificates from host
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - ai-chatbot-rag
      - payment-service
    restart: unless-stopped
    networks:
      - ai-chatbot-network
    healthcheck:
      test: [ "CMD", "nginx", "-t" ]
      interval: 30s
      timeout: 5s
      retries: 3

# ============================================================================
# Networks - Use external network created by deploy-manual.sh
# ============================================================================
networks:
  ai-chatbot-network:
    external: true
    name: ai-chatbot-network

# ============================================================================
# Volumes - Persistent storage
# ============================================================================
volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local
