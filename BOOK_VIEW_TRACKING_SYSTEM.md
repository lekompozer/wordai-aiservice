# Book View Tracking System - Technical Documentation

## Overview

Automatic server-side view tracking system for community books. Counts unique views with **1 view per book per day per user/browser** logic.

**Date:** November 20, 2025
**Commit:** 71bc484

---

## 1. System Architecture

### Tracking Logic

**Rule:** 1 view = 1 unique user/browser reading ANY chapter of a book within 24 hours

**Unique Identifier:**
- **Authenticated users:** `user_id` (Firebase UID)
- **Anonymous users:** `browser_id` (generated by frontend)

**Scope:**
- Only tracks **community books** (`community_config.is_public = true`)
- Private books are NOT tracked

**Deduplication:**
- Uses `book_view_sessions` collection
- Checks if viewer already viewed this book today (00:00 - 23:59 UTC)
- If yes â†’ Skip (no increment)
- If no â†’ Record session + increment `community_config.total_views`

---

## 2. Database Schema

### Collection: `book_view_sessions`

```javascript
{
  _id: ObjectId("..."),
  book_id: "book_4e8ce283775b",
  viewer_id: "firebase_uid_123" | "browser_abc123xyz",
  user_id: "firebase_uid_123",  // null if anonymous
  browser_id: "abc123xyz",      // null if authenticated
  viewed_at: ISODate("2025-11-20T14:30:00Z"),
  expires_at: ISODate("2025-11-21T00:00:00Z")  // TTL cleanup
}
```

**Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `book_id` | string | Book ID being viewed |
| `viewer_id` | string | Unique identifier: user_id OR "browser_{browser_id}" |
| `user_id` | string | Firebase UID (null for anonymous) |
| `browser_id` | string | Browser fingerprint (null for authenticated) |
| `viewed_at` | datetime | Timestamp of view (UTC) |
| `expires_at` | datetime | TTL expiration (end of next day UTC) |

**Indexes:**

```javascript
// 1. Deduplication check
db.book_view_sessions.createIndex(
  {book_id: 1, viewer_id: 1, viewed_at: 1},
  {name: "book_viewer_date_unique", background: true}
)

// 2. TTL auto-cleanup
db.book_view_sessions.createIndex(
  {expires_at: 1},
  {name: "view_session_ttl", expireAfterSeconds: 0, background: true}
)

// 3. Analytics by book
db.book_view_sessions.createIndex(
  {book_id: 1, viewed_at: 1},
  {name: "book_views_by_date", background: true}
)

// 4. Analytics by user (sparse)
db.book_view_sessions.createIndex(
  {user_id: 1, viewed_at: 1},
  {name: "user_views_by_date", sparse: true, background: true}
)
```

### Update: `online_books.community_config`

```javascript
{
  // ... existing fields ...
  "community_config": {
    "is_public": true,
    "total_views": 1520,  // Auto-incremented by view tracking
    // ... other fields ...
  }
}
```

---

## 3. API Changes

### 3.1. Get Chapter Content (By ID)

**Endpoint:** `GET /api/v1/books/{book_id}/chapters/{chapter_id}/content`

**New Parameter:**
```
?browser_id=abc123xyz456  // Optional, required for anonymous users
```

**Behavior:**
1. User requests chapter content
2. Backend extracts `user_id` (if authenticated) or `browser_id` (from query param)
3. **Before returning content:** Call `track_book_view(book_id, user_id, browser_id)`
4. Return chapter content

**Example Requests:**

```bash
# Authenticated user (browser_id optional, user_id from token)
GET /api/v1/books/book_123/chapters/ch_1/content
Authorization: Bearer <firebase_token>

# Anonymous user (MUST provide browser_id)
GET /api/v1/books/book_123/chapters/ch_1/content?browser_id=uuid-abc-123
```

---

### 3.2. Get Chapter Content (By Slug)

**Endpoint:** `GET /api/v1/books/slug/{book_slug}/chapters/{chapter_slug}/content`

**New Parameter:**
```
?browser_id=abc123xyz456  // Optional, required for anonymous users
```

**Behavior:** Same as 3.1

**Example:**
```bash
GET /api/v1/books/slug/word-ai-user-manual/chapters/document-management/content?browser_id=uuid-abc-123
```

---

## 4. Implementation Details

### Helper Function: `track_book_view()`

**Location:** `src/api/book_routes.py` (lines ~4200-4280)

**Signature:**
```python
def track_book_view(
    book_id: str,
    user_id: Optional[str],
    browser_id: Optional[str]
) -> bool
```

**Logic Flow:**

```
1. Validate inputs
   â”œâ”€ If no user_id AND no browser_id â†’ Return False
   â””â”€ Continue

2. Check if community book
   â”œâ”€ Query: {book_id, "community_config.is_public": true}
   â”œâ”€ If not found â†’ Return False (not a community book)
   â””â”€ Continue

3. Create viewer_id
   â”œâ”€ If user_id â†’ viewer_id = user_id
   â””â”€ If browser_id â†’ viewer_id = f"browser_{browser_id}"

4. Get today's date range (UTC)
   â”œâ”€ today_start = 2025-11-20 00:00:00
   â””â”€ today_end = 2025-11-21 00:00:00

5. Check existing view today
   â”œâ”€ Query: {book_id, viewer_id, viewed_at: {$gte: today_start, $lt: today_end}}
   â”œâ”€ If found â†’ Return False (already viewed today)
   â””â”€ Continue

6. Record new view
   â”œâ”€ Insert into book_view_sessions
   â””â”€ Increment: online_books.community_config.total_views + 1

7. Return True (view counted)
```

**Error Handling:**
- All exceptions caught and logged
- Returns `False` on error (fail silently, don't block chapter access)

---

## 5. Frontend Integration

### 5.1. Generate Browser ID

**Recommended Libraries:**
- **FingerprintJS:** https://github.com/fingerprintjs/fingerprintjs
- **UUID:** Simple localStorage-based ID

**Example (localStorage):**

```javascript
// utils/browserTracking.js
export function getBrowserId() {
  const STORAGE_KEY = 'wordai_browser_id';

  // Check existing ID
  let browserId = localStorage.getItem(STORAGE_KEY);

  if (!browserId) {
    // Generate new UUID
    browserId = crypto.randomUUID();
    localStorage.setItem(STORAGE_KEY, browserId);
  }

  return browserId;
}
```

**Example (FingerprintJS - More Robust):**

```javascript
import FingerprintJS from '@fingerprintjs/fingerprintjs';

let fpPromise = null;

export async function getBrowserId() {
  if (!fpPromise) {
    fpPromise = FingerprintJS.load();
  }

  const fp = await fpPromise;
  const result = await fp.get();

  return result.visitorId;  // Stable browser fingerprint
}
```

---

### 5.2. API Calls

**Authenticated User:**

```javascript
// Read chapter (browser_id optional but recommended)
const browserId = getBrowserId();

fetch(`/api/v1/books/${bookId}/chapters/${chapterId}/content?browser_id=${browserId}`, {
  headers: {
    'Authorization': `Bearer ${firebaseToken}`
  }
})
```

**Anonymous User:**

```javascript
// Read chapter (browser_id REQUIRED)
const browserId = getBrowserId();

fetch(`/api/v1/books/${bookId}/chapters/${chapterId}/content?browser_id=${browserId}`)
```

---

### 5.3. React Hook Example

```typescript
// hooks/useChapterContent.ts
import { useState, useEffect } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { getBrowserId } from '@/utils/browserTracking';

export function useChapterContent(bookId: string, chapterId: string) {
  const [content, setContent] = useState(null);
  const [loading, setLoading] = useState(true);
  const { user, token } = useAuth();

  useEffect(() => {
    async function fetchChapter() {
      try {
        const browserId = await getBrowserId();
        const url = new URL(`/api/v1/books/${bookId}/chapters/${chapterId}/content`, API_BASE);
        url.searchParams.set('browser_id', browserId);

        const headers: any = {};
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        const response = await fetch(url.toString(), { headers });
        const data = await response.json();

        setContent(data);
      } catch (error) {
        console.error('Failed to fetch chapter:', error);
      } finally {
        setLoading(false);
      }
    }

    fetchChapter();
  }, [bookId, chapterId, token]);

  return { content, loading };
}
```

---

## 6. Deployment Steps

### Step 1: Setup MongoDB Indexes

**Run setup script:**

```bash
# Development
ENV=development python setup_view_tracking_indexes.py

# Production (via SSH)
ssh root@104.248.147.155
su - hoile
cd /home/hoile/wordai
docker-compose exec aiservice python setup_view_tracking_indexes.py
```

**Expected Output:**

```
ðŸ”— Connecting to MongoDB...
âœ… Connected to database: wordai

ðŸ“‹ Creating indexes for book_view_sessions collection...
âœ… Created index: book_viewer_date_unique (book_id, viewer_id, viewed_at)
âœ… Created TTL index: view_session_ttl (expires_at)
âœ… Created index: book_views_by_date (book_id, viewed_at)
âœ… Created index: user_views_by_date (user_id, viewed_at)

âœ… All indexes created successfully!
```

---

### Step 2: Deploy Code

```bash
# Local: Push to GitHub
git push origin main

# Production: Deploy
ssh root@104.248.147.155 "su - hoile -c 'cd /home/hoile/wordai && git pull origin main && ./deploy-compose-with-rollback.sh'"
```

---

### Step 3: Verify Tracking

**Test Anonymous View:**

```bash
curl "https://ai.wordai.pro/api/v1/books/book_4e8ce283775b/chapters/chapter_5b6ec27818eb/content?browser_id=test-browser-123"
```

**Check MongoDB:**

```javascript
// Connect to MongoDB
use wordai

// Check view sessions
db.book_view_sessions.find().pretty()

// Expected output:
{
  "_id": ObjectId("..."),
  "book_id": "book_4e8ce283775b",
  "viewer_id": "browser_test-browser-123",
  "user_id": null,
  "browser_id": "test-browser-123",
  "viewed_at": ISODate("2025-11-20T14:30:00Z"),
  "expires_at": ISODate("2025-11-21T00:00:00Z")
}

// Check book views incremented
db.online_books.findOne(
  {"book_id": "book_4e8ce283775b"},
  {"community_config.total_views": 1}
)
// Expected: total_views increased by 1
```

---

## 7. Analytics Queries

### 7.1. Total Views by Book (Today)

```javascript
db.book_view_sessions.aggregate([
  {
    $match: {
      viewed_at: {
        $gte: ISODate("2025-11-20T00:00:00Z"),
        $lt: ISODate("2025-11-21T00:00:00Z")
      }
    }
  },
  {
    $group: {
      _id: "$book_id",
      views_today: {$sum: 1},
      unique_viewers: {$addToSet: "$viewer_id"}
    }
  },
  {$sort: {views_today: -1}},
  {$limit: 10}
])
```

---

### 7.2. Views Trend (Last 7 Days)

```javascript
db.book_view_sessions.aggregate([
  {
    $match: {
      book_id: "book_4e8ce283775b",
      viewed_at: {$gte: new Date(Date.now() - 7*24*60*60*1000)}
    }
  },
  {
    $group: {
      _id: {
        $dateToString: {format: "%Y-%m-%d", date: "$viewed_at"}
      },
      views: {$sum: 1}
    }
  },
  {$sort: {_id: 1}}
])
```

---

### 7.3. Top Books (This Month)

```javascript
db.book_view_sessions.aggregate([
  {
    $match: {
      viewed_at: {$gte: ISODate("2025-11-01T00:00:00Z")}
    }
  },
  {
    $group: {
      _id: "$book_id",
      total_views: {$sum: 1}
    }
  },
  {$sort: {total_views: -1}},
  {$limit: 10}
])
```

---

## 8. Performance Considerations

### Database Performance

**Indexes:** All created by setup script
- Query performance: O(log n) for deduplication check
- TTL cleanup: Automatic, no manual maintenance

**Estimated Load:**
- 1000 unique users/day Ã— 5 books/user = 5000 documents/day
- TTL deletes after 24-48h = ~10,000 documents max
- Negligible storage: ~1KB per document = 10MB total

**Write Load:**
- 2 writes per view: 1 insert + 1 update
- With proper indexes: <10ms per view
- Async operation: Doesn't block chapter content response

---

### Optimization Tips

**1. Batch Processing (Future):**
```python
# Instead of immediate increment, queue views
# Process in batches every 5 minutes
redis.sadd(f"views:book_{book_id}:pending", viewer_id)

# Cron job:
# 1. Get all pending views
# 2. Deduplicate
# 3. Batch insert to MongoDB
# 4. Batch increment book counters
```

**2. Caching:**
```python
# Cache recent views in Redis (5-minute window)
cache_key = f"view:{book_id}:{viewer_id}:{today}"
if redis.exists(cache_key):
    return False  # Already viewed (cached)

# Record view + cache for 24h
redis.setex(cache_key, 86400, "1")
```

---

## 9. Troubleshooting

### Issue: Views not counting

**Check 1: Is it a community book?**
```javascript
db.online_books.findOne(
  {"book_id": "book_xyz"},
  {"community_config.is_public": 1}
)
// Must be: community_config.is_public = true
```

**Check 2: Browser ID provided?**
```
# Anonymous request MUST have browser_id
curl ".../content?browser_id=abc123"
```

**Check 3: Already viewed today?**
```javascript
db.book_view_sessions.find({
  book_id: "book_xyz",
  viewer_id: "browser_abc123",
  viewed_at: {
    $gte: ISODate("2025-11-20T00:00:00Z"),
    $lt: ISODate("2025-11-21T00:00:00Z")
  }
})
// If found â†’ View not counted (deduplication)
```

---

### Issue: TTL not cleaning up

**Check TTL index:**
```javascript
db.book_view_sessions.getIndexes()
// Look for: expireAfterSeconds: 0
```

**Force cleanup (if needed):**
```javascript
db.book_view_sessions.deleteMany({
  expires_at: {$lt: new Date()}
})
```

---

## 10. Future Enhancements

### Phase 2: Advanced Analytics

**Features to add:**
- Per-chapter view tracking
- Reading time analytics (time spent on chapter)
- Scroll depth tracking (how far user read)
- Exit chapter analytics (where users stop reading)
- Traffic source tracking (referrer analysis)

**Dashboard Metrics:**
- Real-time view counter
- Views trend (hourly/daily/weekly)
- Peak reading times
- Geographic distribution (if IP geolocation added)
- User retention (repeat readers)

---

## 11. Summary

âœ… **Implemented:**
- Server-side auto tracking (no frontend dependency)
- 1 view per book per day per user/browser
- Community books only
- MongoDB with TTL auto-cleanup
- Anonymous + authenticated support

âœ… **Benefits:**
- Accurate view counting
- No double-counting
- Fraud-resistant
- Performance optimized
- Zero maintenance (TTL cleanup)

âœ… **Next Steps:**
1. Deploy to production
2. Setup MongoDB indexes
3. Frontend integration (browser_id)
4. Monitor analytics
5. Add dashboard (future)

**Contact:** Support team for questions
**Documentation:** This file + inline code comments
