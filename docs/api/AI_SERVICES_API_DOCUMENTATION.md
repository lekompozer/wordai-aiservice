# AI Services API Documentation

## üìñ T·ªïng quan

T√†i li·ªáu n√†y m√¥ t·∫£ c√°c API endpoints c·ªßa h·ªá th·ªëng AI Services, bao g·ªìm:
- **Chat Services**: C√°c API cho t√≠nh nƒÉng chat v√† x·ª≠ l√Ω t√†i li·ªáu
- **Loan Assessment**: API th·∫©m ƒë·ªãnh h·ªì s∆° vay ng√¢n h√†ng
- **OCR Services**: API nh·∫≠n d·∫°ng k√Ω t·ª± quang h·ªçc (CCCD)
- **AI Sales Agent**: API t∆∞ v·∫•n vay th√¥ng minh v·ªõi NLU/NLG

---

## üîó Base URLs

- **Production**: `https://ai.aimoney.io.vn`
- **Development**: `http://localhost:8000`

---

## üìã Authentication

H·ªá th·ªëng s·ª≠ d·ª•ng API keys ƒë∆∞·ª£c c·∫•u h√¨nh trong environment variables:
- `DEEPSEEK_API_KEY`: Cho DeepSeek AI
- `CHATGPT_API_KEY`: Cho ChatGPT/OpenAI

---

## ü§ñ Chat Services

### 1. Basic Chat (Non-streaming)

**Endpoint**: `POST /chat`

**M√¥ t·∫£**: API chat c∆° b·∫£n tr·∫£ v·ªÅ response m·ªôt l·∫ßn

**Request Body**:
```json
{
  "question": "L√£i su·∫•t vay mua nh√† hi·ªán t·∫°i nh∆∞ th·∫ø n√†o?",
  "session_id": "session_123",
  "userId": "user_456",
  "tone": "professional"
}
```

**Response**:
```json
{
  "response": "L√£i su·∫•t vay mua nh√† hi·ªán t·∫°i dao ƒë·ªông t·ª´ 8.5% - 12% t√πy thu·ªôc v√†o...",
  "session_id": "session_123",
  "timestamp": "2025-07-11T10:30:00"
}
```

**Tham s·ªë**:
- `question` (string, required): C√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng
- `session_id` (string, optional): ID phi√™n chat
- `userId` (string, optional): ID ng∆∞·ªùi d√πng
- `tone` (string, optional): Tone ƒëi·ªÅu ch·ªânh (professional, friendly, formal)

---

### 2. Streaming Chat

**Endpoint**: `POST /chat-stream`

**M√¥ t·∫£**: API chat streaming tr·∫£ v·ªÅ response theo t·ª´ng chunk

**Request Body**:
```json
{
  "question": "T√¥i mu·ªën vay 500 tri·ªáu mua nh√†, ƒëi·ªÅu ki·ªán nh∆∞ th·∫ø n√†o?",
  "session_id": "session_123",
  "userId": "user_456",
  "deviceId": "device_789"
}
```

**Response**: Server-Sent Events (SSE)
```
data: {"chunk": "[Theo d·ªØ li·ªáu ·ª©ng d·ª•ng] "}
data: {"chunk": "ƒê·ªÉ vay 500 tri·ªáu"}
data: {"chunk": " mua nh√†, b·∫°n c·∫ßn"}
data: {"chunk": " ƒë√°p ·ª©ng c√°c ƒëi·ªÅu ki·ªán..."}
data: {"done": true}
```

**Headers**:
- `Content-Type`: `text/event-stream`
- `Cache-Control`: `no-cache`

---

### 3. Chat with Files (Streaming)

**Endpoint**: `POST /chat-with-files-stream`

**M√¥ t·∫£**: API chat v·ªõi kh·∫£ nƒÉng x·ª≠ l√Ω t√†i li·ªáu ƒë√≠nh k√®m

**Request Body**:
```json
{
  "question": "Ph√¢n t√≠ch t√†i li·ªáu n√†y cho t√¥i",
  "files": ["base64_encoded_file_1", "base64_encoded_file_2"],
  "file_names": ["document1.pdf", "document2.docx"],
  "file_types": ["application/pdf", "application/vnd.openxmlformats-officedocument.wordprocessingml.document"],
  "session_id": "session_123",
  "userId": "user_456",
  "tone": "analytical"
}
```

**Response**: Server-Sent Events (SSE)
```
data: {"content": "D·ª±a tr√™n t√†i li·ªáu b·∫°n cung c·∫•p..."}
data: {"content": " T√¥i th·∫•y r·∫±ng..."}
data: {"done": true, "processed_files": ["document1.pdf"], "total_files": 2}
```

**Supported File Types**:
- PDF documents
- Word documents (.docx)
- Text files (.txt)
- Images (for OCR processing)

---

### 4. Clear Chat History

**Endpoint**: `POST /clear-history`

**M√¥ t·∫£**: X√≥a l·ªãch s·ª≠ chat c·ªßa m·ªôt session

**Request Body**:
```json
{
  "session_id": "session_123",
  "userId": "user_456"
}
```

**Response**:
```json
{
  "message": "History cleared successfully",
  "session_id": "session_123",
  "timestamp": "2025-07-11T10:30:00"
}
```

---

### 5. Get AI Providers

**Endpoint**: `GET /ai-providers`

**M√¥ t·∫£**: L·∫•y danh s√°ch c√°c AI providers c√≥ s·∫µn

**Response**:
```json
{
  "available_providers": ["deepseek", "chatgpt"],
  "current_provider": "deepseek",
  "timestamp": "2025-07-11T10:30:00"
}
```

---

## üè¶ Loan Assessment Services

### 1. Loan Credit Assessment

**Endpoint**: `POST /api/loan/assessment`

**M√¥ t·∫£**: API th·∫©m ƒë·ªãnh h·ªì s∆° vay ng√¢n h√†ng v·ªõi DeepSeek Reasoning

**Request Body**:
```json
{
  "applicationId": "APP_20250711_001",
  "loanAmount": 500000000,
  "loanTerm": "15 nƒÉm",
  "interestRate": 8.5,
  "fullName": "Nguy·ªÖn VƒÉn A",
  "monthlyIncome": 30000000,
  "primaryIncomeSource": "L∆∞∆°ng",
  "companyName": "C√¥ng ty ABC",
  "jobTitle": "K·ªπ s∆∞ ph·∫ßn m·ªÅm",
  "workExperience": 5,
  "collateralValue": 800000000,
  "monthlyDebtPayment": 5000000,
  "otherIncomeAmount": 2000000,
  "dependents": 2,
  "maritalStatus": "ƒê√£ k·∫øt h√¥n",
  "email": "nguyen.van.a@email.com",
  "phoneNumber": "0901234567",
  "phoneCountryCode": "+84"
}
```

**Response**:
```json
{
  "success": true,
  "applicationId": "APP_20250711_001",
  "assessmentId": "assessment_1720684200000",
  "status": "APPROVED",
  "confidence": 0.85,
  "creditScore": 750,
  "reasoning": "Kh√°ch h√†ng c√≥ thu nh·∫≠p ·ªïn ƒë·ªãnh...",
  "riskFactors": [
    "DTI ratio cao (45%)",
    "Th·ªùi gian l√†m vi·ªác ng·∫Øn"
  ],
  "recommendations": [
    "Y√™u c·∫ßu b·∫£o l√£nh b·ªï sung",
    "Gi·∫£m s·ªë ti·ªÅn vay xu·ªëng 450 tri·ªáu"
  ],
  "approvedAmount": 450000000,
  "interestRate": 9.2,
  "monthlyPayment": 4250000,
  "loanToValue": 0.65,
  "debtToIncome": 0.42,
  "conditions": [
    "Cung c·∫•p b·∫£ng l∆∞∆°ng 6 th√°ng g·∫ßn nh·∫•t",
    "B·∫£o hi·ªÉm kho·∫£n vay"
  ],
  "collateralValuation": {
    "estimatedValue": 800000000,
    "ltvRatio": 0.65,
    "riskAssessment": "LOW"
  },
  "financialAnalysis": {
    "totalMonthlyIncome": 32000000,
    "estimatedMonthlyPayment": 4250000,
    "remainingIncome": 22750000,
    "debtServiceCoverage": 3.2
  },
  "processingDetails": {
    "assessmentId": "assessment_1720684200000",
    "processingTime": 2.45,
    "reasoningDuration": 1.8,
    "modelUsed": "deepseek-reasoning"
  }
}
```

**C√°c tr∆∞·ªùng b·∫Øt bu·ªôc**:
- `applicationId`: ID ƒë∆°n vay
- `loanAmount`: S·ªë ti·ªÅn vay (VNƒê)
- `monthlyIncome`: Thu nh·∫≠p h√†ng th√°ng (VNƒê)

**C√°c ch·ªâ s·ªë ƒë√°nh gi√°**:
- **DTI Ratio**: T·ª∑ l·ªá n·ª£/thu nh·∫≠p (‚â§40% t·ªët, >50% r·ªßi ro)
- **LTV Ratio**: T·ª∑ l·ªá vay/gi√° tr·ªã t√†i s·∫£n (‚â§70% t·ªët, >80% r·ªßi ro)
- **Credit Score**: ƒêi·ªÉm t√≠n d·ª•ng (300-850)
- **Debt Service Coverage**: Kh·∫£ nƒÉng thanh to√°n n·ª£ (>1.25x recommended)

---

## üÜî OCR Services

### 1. CCCD OCR Processing

**Endpoint**: `POST /api/ocr/cccd`

**M√¥ t·∫£**: API nh·∫≠n d·∫°ng th√¥ng tin t·ª´ CƒÉn c∆∞·ªõc c√¥ng d√¢n (CCCD) Vi·ªát Nam

**Request Body**:
```json
{
  "image": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEA...",
  "extract_mode": "full"
}
```

**Response**:
```json
{
  "success": true,
  "extracted_data": {
    "id_number": "001234567890",
    "full_name": "NGUY·ªÑN VƒÇN A",
    "date_of_birth": "01/01/1990",
    "gender": "Nam",
    "nationality": "Vi·ªát Nam",
    "place_of_origin": "H√† N·ªôi",
    "place_of_residence": "123 ƒê∆∞·ªùng ABC, Ph∆∞·ªùng XYZ, Qu·∫≠n 1, TP.HCM",
    "issue_date": "01/01/2021",
    "expiry_date": "01/01/2031",
    "issuing_authority": "C·ª•c C·∫£nh s√°t qu·∫£n l√Ω h√†nh ch√≠nh v·ªÅ tr·∫≠t t·ª± x√£ h·ªôi"
  },
  "confidence_scores": {
    "id_number": 0.98,
    "full_name": 0.95,
    "date_of_birth": 0.97,
    "overall": 0.96
  },
  "processing_time": 1.23,
  "model_used": "gpt-4-vision",
  "image_quality": "HIGH"
}
```

**Tham s·ªë**:
- `image` (string, required): ·∫¢nh CCCD ƒë∆∞·ª£c encode base64
- `extract_mode` (string, optional): "full" ho·∫∑c "basic"

**Supported Image Formats**:
- JPEG, PNG, WebP
- K√≠ch th∆∞·ªõc t·ªëi ƒëa: 10MB
- ƒê·ªô ph√¢n gi·∫£i khuy·∫øn ngh·ªã: ‚â•1024x768

---

### 2. Test OCR URL

**Endpoint**: `POST /test-ocr-url`

**M√¥ t·∫£**: API test OCR v·ªõi URL ·∫£nh

**Request Body**:
```json
{
  "image_url": "https://example.com/cccd-image.jpg"
}
```

---

## ü§ñ AI Sales Agent Services

### 1. Process User Input

**Endpoint**: `POST /ai-sales-agent/process`

**M√¥ t·∫£**: API x·ª≠ l√Ω ƒë·∫ßu v√†o ng∆∞·ªùi d√πng trong quy tr√¨nh t∆∞ v·∫•n vay th√¥ng minh

**Request Body**:
```json
{
  "sessionId": "loan_session_123",
  "userMessage": "T√¥i mu·ªën vay 500 tri·ªáu ƒë·ªÉ mua nh√†"
}
```

**Response**:
```json
{
  "sessionId": "loan_session_123",
  "response": "C·∫£m ∆°n anh ƒë√£ quan t√¢m ƒë·∫øn s·∫£n ph·∫©m vay mua nh√†. V·ªõi s·ªë ti·ªÅn 500 tri·ªáu, ch√∫ng t√¥i c√≥ th·ªÉ h·ªó tr·ª£ anh. Cho t√¥i xin th√¥ng tin v·ªÅ lo·∫°i h√¨nh vay anh mong mu·ªën?",
  "currentStep": "STEP_1_2",
  "extractedFields": {
    "loanAmount": 500000000
  },
  "isCompleted": false,
  "nextStep": "STEP_1_2",
  "missingFields": ["loanType"],
  "confidence": 0.92
}
```

**Quy tr√¨nh 13 b∆∞·ªõc**:
1. **Step 1.1**: S·ªë ti·ªÅn vay
2. **Step 1.2**: Lo·∫°i h√¨nh vay
3. **Step 2.1**: Th√¥ng tin c√° nh√¢n
4. **Step 2.2**: S·ªë ng∆∞·ªùi ph·ª• thu·ªôc
5. **Step 3.1**: Lo·∫°i t√†i s·∫£n ƒë·∫£m b·∫£o
6. **Step 3.2**: Gi√° tr·ªã t√†i s·∫£n
7. **Step 4.1**: Ngu·ªìn thu nh·∫≠p ch√≠nh
8. **Step 4.2**: Th√¥ng tin c√¥ng vi·ªác
9. **Step 4.3**: T√†i s·∫£n kh√°c
10. **Step 5.1**: C√≥ n·ª£ hi·ªán t·∫°i kh√¥ng
11. **Step 5.2**: Chi ti·∫øt n·ª£ (n·∫øu c√≥)
12. **Step 6**: X√°c nh·∫≠n th√¥ng tin t·ªïng h·ª£p
13. **Step 7**: Th·∫©m ƒë·ªãnh h·ªì s∆° vay t·ª± ƒë·ªông

---

### 2. Get Session Info

**Endpoint**: `GET /ai-sales-agent/session/{session_id}`

**M√¥ t·∫£**: L·∫•y th√¥ng tin v·ªÅ phi√™n t∆∞ v·∫•n

**Response**:
```json
{
  "sessionId": "loan_session_123",
  "currentStep": "STEP_2_1",
  "extractedFields": {
    "loanAmount": 500000000,
    "loanType": "Th·∫ø ch·∫•p"
  },
  "isCompleted": false,
  "createdAt": "2025-07-11T10:00:00",
  "updatedAt": "2025-07-11T10:15:00",
  "messageCount": 6
}
```

---

### 3. Get Conversation History

**Endpoint**: `GET /ai-sales-agent/session/{session_id}/history`

**M√¥ t·∫£**: L·∫•y l·ªãch s·ª≠ h·ªôi tho·∫°i ƒë·∫ßy ƒë·ªß

**Response**:
```json
{
  "sessionId": "loan_session_123",
  "history": [
    {
      "timestamp": "2025-07-11T10:00:00",
      "role": "assistant",
      "message": "Xin ch√†o! T√¥i l√† AI Assistant...",
      "step": "STEP_1_1"
    },
    {
      "timestamp": "2025-07-11T10:01:00",
      "role": "user",
      "message": "T√¥i mu·ªën vay 500 tri·ªáu",
      "step": "STEP_1_1"
    }
  ],
  "currentStep": "STEP_2_1",
  "isCompleted": false
}
```

---

### 4. Reset Session

**Endpoint**: `POST /ai-sales-agent/session/{session_id}/reset`

**M√¥ t·∫£**: Reset phi√™n t∆∞ v·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i

**Response**:
```json
{
  "sessionId": "loan_session_123",
  "message": "Xin ch√†o! T√¥i l√† AI Assistant c·ªßa ng√¢n h√†ng...",
  "currentStep": "STEP_1_1",
  "status": "reset_complete"
}
```

---

### 6. Confirmation Summary

**Endpoint**: `POST /ai-sales-agent/process` (Step 6)

**M√¥ t·∫£**: Hi·ªÉn th·ªã t·ªïng h·ª£p th√¥ng tin ƒë·ªÉ ng∆∞·ªùi d√πng x√°c nh·∫≠n tr∆∞·ªõc khi th·∫©m ƒë·ªãnh

**Request Body**:
```json
{
  "sessionId": "loan_session_123",
  "userMessage": "X√°c nh·∫≠n" 
}
```

**Response - Step 6 Summary**:
```json
{
  "sessionId": "loan_session_123",
  "response": "üìã **X√ÅC NH·∫¨N TH√îNG TIN H·ªí S∆† VAY**\n\n**1Ô∏è‚É£ TH√îNG TIN KHO·∫¢N VAY**\n‚Ä¢ S·ªë ti·ªÅn vay: 500,000,000 VNƒê\n‚Ä¢ Th·ªùi h·∫°n: 15 nƒÉm\n‚Ä¢ M·ª•c ƒë√≠ch: Mua nh√†\n‚Ä¢ H√¨nh th·ª©c: Th·∫ø ch·∫•p\n\n**2Ô∏è‚É£ TH√îNG TIN C√Å NH√ÇN**\n‚Ä¢ H·ªç t√™n: Nguy·ªÖn VƒÉn A\n‚Ä¢ Gi·ªõi t√≠nh: Nam\n‚Ä¢ NƒÉm sinh: 1990\n‚Ä¢ SƒêT: 0901234567\n‚Ä¢ Email: nguyen.van.a@email.com\n‚Ä¢ T√¨nh tr·∫°ng h√¥n nh√¢n: ƒê√£ k·∫øt h√¥n\n‚Ä¢ S·ªë ng∆∞·ªùi ph·ª• thu·ªôc: 2\n\n**3Ô∏è‚É£ T√ÄI S·∫¢N ƒê·∫¢M B·∫¢O**\n‚Ä¢ Lo·∫°i t√†i s·∫£n: B·∫•t ƒë·ªông s·∫£n\n‚Ä¢ M√¥ t·∫£: CƒÉn h·ªô chung c∆∞\n‚Ä¢ Gi√° tr·ªã ∆∞·ªõc t√≠nh: 800,000,000 VNƒê\n\n**4Ô∏è‚É£ TH√îNG TIN T√ÄI CH√çNH**\n‚Ä¢ Thu nh·∫≠p h√†ng th√°ng: 30,000,000 VNƒê\n‚Ä¢ Ngu·ªìn thu nh·∫≠p: L∆∞∆°ng\n‚Ä¢ C√¥ng ty: C√¥ng ty ABC\n‚Ä¢ Ch·ª©c v·ª•: K·ªπ s∆∞ ph·∫ßn m·ªÅm\n‚Ä¢ Kinh nghi·ªám: 5 nƒÉm\n‚Ä¢ Thu nh·∫≠p kh√°c: 2,000,000 VNƒê\n\n**5Ô∏è‚É£ TH√îNG TIN N·ª¢**\n‚Ä¢ C√≥ n·ª£ hi·ªán t·∫°i: C√≥\n‚Ä¢ T·ªïng d∆∞ n·ª£: 50,000,000 VNƒê\n‚Ä¢ Tr·∫£ n·ª£ h√†ng th√°ng: 5,000,000 VNƒê\n\n---\n‚ö†Ô∏è **Vui l√≤ng ki·ªÉm tra k·ªπ th√¥ng tin tr√™n.**\n\nTr·∫£ l·ªùi:\n- **\"X√°c nh·∫≠n\"** - n·∫øu th√¥ng tin ch√≠nh x√°c\n- **\"S·ª≠a [field]: [gi√° tr·ªã m·ªõi]\"** - ƒë·ªÉ ch·ªânh s·ª≠a\n  V√≠ d·ª•: \"S·ª≠a thu nh·∫≠p: 35 tri·ªáu\"",
  "currentStep": "STEP_6",
  "extractedFields": {
    "loanAmount": 500000000,
    "loanTerm": "15 nƒÉm",
    "loanPurpose": "Mua nh√†",
    "loanType": "Th·∫ø ch·∫•p",
    "fullName": "Nguy·ªÖn VƒÉn A",
    "gender": "Nam",
    "birthYear": 1990,
    "phoneNumber": "0901234567",
    "email": "nguyen.van.a@email.com",
    "maritalStatus": "ƒê√£ k·∫øt h√¥n",
    "dependents": 2,
    "collateralType": "B·∫•t ƒë·ªông s·∫£n",
    "collateralInfo": "CƒÉn h·ªô chung c∆∞",
    "collateralValue": 800000000,
    "monthlyIncome": 30000000,
    "primaryIncomeSource": "L∆∞∆°ng",
    "companyName": "C√¥ng ty ABC",
    "jobTitle": "K·ªπ s∆∞ ph·∫ßn m·ªÅm",
    "workExperience": 5,
    "otherIncomeAmount": 2000000,
    "hasExistingDebt": true,
    "totalDebtAmount": 50000000,
    "monthlyDebtPayment": 5000000
  },
  "isCompleted": false,
  "nextStep": "STEP_7",
  "missingFields": ["userConfirmation"],
  "confidence": 1.0,
  "actions": [
    "X√°c nh·∫≠n - ƒë·ªÉ ti·∫øp t·ª•c th·∫©m ƒë·ªãnh",
    "S·ª≠a [t√™n field]: [gi√° tr·ªã m·ªõi] - ƒë·ªÉ ch·ªânh s·ª≠a"
  ]
}
```

**Editing Commands**:
- `"S·ª≠a l∆∞∆°ng: 35 tri·ªáu"` ‚Üí C·∫≠p nh·∫≠t monthlyIncome = 35000000
- `"S·ª≠a t√™n: Nguy·ªÖn Th·ªã B"` ‚Üí C·∫≠p nh·∫≠t fullName = "Nguy·ªÖn Th·ªã B"
- `"S·ª≠a t√†i s·∫£n: 1 t·ª∑"` ‚Üí C·∫≠p nh·∫≠t collateralValue = 1000000000

---

### 7. Loan Assessment Processing

**Endpoint**: `POST /ai-sales-agent/process` (Step 7)

**M√¥ t·∫£**: Th·ª±c hi·ªán th·∫©m ƒë·ªãnh h·ªì s∆° vay t·ª± ƒë·ªông sau khi user x√°c nh·∫≠n

**Request Body**:
```json
{
  "sessionId": "loan_session_123",
  "userMessage": "X√°c nh·∫≠n"
}
```

**Response - Step 7 Assessment**:
```json
{
  "sessionId": "loan_session_123",
  "response": "üéâ **TH·∫®M ƒê·ªäNH H·ªí S∆† HO√ÄN T·∫§T**\n\n‚úÖ **K·∫æT QU·∫¢: CH·∫§P THU·∫¨N**\n\nüìä **CHI TI·∫æT ƒê√ÅNH GI√Å:**\n‚Ä¢ ƒêi·ªÉm t√≠n d·ª•ng: 750/850 (T·ªët)\n‚Ä¢ T·ª∑ l·ªá DTI: 42% (Ch·∫•p nh·∫≠n ƒë∆∞·ª£c)\n‚Ä¢ T·ª∑ l·ªá LTV: 65% (An to√†n)\n‚Ä¢ ƒê·ªô tin c·∫≠y: 85%\n\nüí∞ **ƒêI·ªÄU KI·ªÜN VAY:**\n‚Ä¢ S·ªë ti·ªÅn ƒë∆∞·ª£c duy·ªát: 450,000,000 VNƒê\n‚Ä¢ L√£i su·∫•t: 9.2%/nƒÉm\n‚Ä¢ K·ª≥ h·∫°n: 15 nƒÉm\n‚Ä¢ Tr·∫£ g√≥p h√†ng th√°ng: 4,250,000 VNƒê\n\n‚ö†Ô∏è **Y√äU C·∫¶U B·ªî SUNG:**\n‚Ä¢ Cung c·∫•p b·∫£ng l∆∞∆°ng 6 th√°ng g·∫ßn nh·∫•t\n‚Ä¢ B·∫£o hi·ªÉm kho·∫£n vay\n‚Ä¢ Th·∫©m ƒë·ªãnh gi√° t√†i s·∫£n ch√≠nh th·ª©c\n\nüìû **B∆Ø·ªöC TI·∫æP THEO:**\nNh√¢n vi√™n t∆∞ v·∫•n s·∫Ω li√™n h·ªá trong 24h ƒë·ªÉ h∆∞·ªõng d·∫´n ho√†n thi·ªán h·ªì s∆°.\n\nM√£ h·ªì s∆°: **APP_20250711_001**",
  "currentStep": "STEP_7",
  "extractedFields": {
    "loanAmount": 500000000,
    "loanType": "Th·∫ø ch·∫•p",
    "assessmentResult": {
      "status": "APPROVED",
      "confidence": 0.85,
      "creditScore": 750,
      "approvedAmount": 450000000,
      "interestRate": 9.2,
      "monthlyPayment": 4250000,
      "loanToValue": 0.65,
      "debtToIncome": 0.42,
      "conditions": [
        "Cung c·∫•p b·∫£ng l∆∞∆°ng 6 th√°ng g·∫ßn nh·∫•t",
        "B·∫£o hi·ªÉm kho·∫£n vay",
        "Th·∫©m ƒë·ªãnh gi√° t√†i s·∫£n ch√≠nh th·ª©c"
      ],
      "applicationId": "APP_20250711_001"
    }
  },
  "isCompleted": true,
  "nextStep": null,
  "missingFields": [],
  "confidence": 0.85
}
```

**Assessment API Call Structure**:

Khi user x√°c nh·∫≠n ·ªü Step 6, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông g·ªçi API assessment:

```bash
POST /api/loan/assessment
Content-Type: application/json

{
  "applicationId": "APP_20250711_001",
  "loanAmount": 500000000,
  "loanTerm": "15 nƒÉm",
  "interestRate": 8.5,
  "fullName": "Nguy·ªÖn VƒÉn A",
  "monthlyIncome": 30000000,
  "primaryIncomeSource": "L∆∞∆°ng",
  "companyName": "C√¥ng ty ABC",
  "jobTitle": "K·ªπ s∆∞ ph·∫ßn m·ªÅm",
  "workExperience": 5,
  "collateralValue": 800000000,
  "monthlyDebtPayment": 5000000,
  "otherIncomeAmount": 2000000,
  "dependents": 2,
  "maritalStatus": "ƒê√£ k·∫øt h√¥n",
  "email": "nguyen.van.a@email.com",
  "phoneNumber": "0901234567",
  "phoneCountryCode": "+84"
}
```

**Assessment Flow**:
1. **Step 6**: Hi·ªÉn th·ªã summary ‚Üí User x√°c nh·∫≠n ho·∫∑c s·ª≠a
2. **Data Preparation**: Convert extracted_fields ‚Üí assessment API format
3. **API Call**: POST /api/loan/assessment v·ªõi d·ªØ li·ªáu ƒë√£ chu·∫©n b·ªã
4. **Step 7**: Hi·ªÉn th·ªã k·∫øt qu·∫£ th·∫©m ƒë·ªãnh ƒë·∫πp m·∫Øt cho user

**Error Handling**:
```json
{
  "sessionId": "loan_session_123",
  "response": "‚ùå **L·ªñI TH·∫®M ƒê·ªäNH**\n\nH·ªá th·ªëng t·∫°m th·ªùi g·∫∑p s·ª± c·ªë. Vui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t.\n\nM√£ l·ªói: ASSESSMENT_SERVICE_ERROR",
  "currentStep": "STEP_6", 
  "error": "Assessment service temporarily unavailable",
  "isCompleted": false
}
```

---

### 8. Health Check

**Endpoint**: `GET /ai-sales-agent/health`

**M√¥ t·∫£**: Ki·ªÉm tra t√¨nh tr·∫°ng ho·∫°t ƒë·ªông c·ªßa AI Sales Agent

**Response**:
```json
{
  "status": "healthy",
  "service": "AI Sales Agent",
  "timestamp": "2025-07-11T10:30:00",
  "active_sessions": 45
}
```

---

## üìä Error Handling

### C·∫•u tr√∫c l·ªói chung

```json
{
  "success": false,
  "error": "M√¥ t·∫£ l·ªói",
  "error_code": "VALIDATION_ERROR",
  "timestamp": "2025-07-11T10:30:00",
  "processing_time": 0.15
}
```

### C√°c m√£ l·ªói ph·ªï bi·∫øn

| M√£ l·ªói | HTTP Status | M√¥ t·∫£ |
|---------|-------------|--------|
| `VALIDATION_ERROR` | 400 | D·ªØ li·ªáu ƒë·∫ßu v√†o kh√¥ng h·ª£p l·ªá |
| `API_KEY_MISSING` | 401 | Thi·∫øu API key |
| `SESSION_NOT_FOUND` | 404 | Kh√¥ng t√¨m th·∫•y session |
| `AI_SERVICE_ERROR` | 500 | L·ªói t·ª´ d·ªãch v·ª• AI |
| `PROCESSING_TIMEOUT` | 504 | Timeout x·ª≠ l√Ω |

---

## üîß Configuration

### Environment Variables

```bash
# AI API Keys
DEEPSEEK_API_KEY=your_deepseek_api_key
CHATGPT_API_KEY=your_chatgpt_api_key

# Server Configuration
PORT=8000
DEBUG=true

# Database (Redis for sessions)
REDIS_URL=redis://localhost:6379

# Logging
LOG_LEVEL=INFO
```

---

## üìà Rate Limits

| Endpoint | Gi·ªõi h·∫°n | Th·ªùi gian |
|----------|----------|-----------|
| `/chat` | 100 requests | 1 ph√∫t |
| `/chat-stream` | 50 requests | 1 ph√∫t |
| `/api/loan/assessment` | 20 requests | 1 ph√∫t |
| `/api/ocr/cccd` | 30 requests | 1 ph√∫t |
| `/ai-sales-agent/*` | 200 requests | 1 ph√∫t |

---

## üöÄ Examples

### Quy tr√¨nh ho√†n ch·ªânh AI Sales Agent (13 b∆∞·ªõc)

```bash
# 1. B·∫Øt ƒë·∫ßu conversation
curl -X POST "http://localhost:8000/ai-sales-agent/process" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test_session",
    "userMessage": "T√¥i mu·ªën vay ti·ªÅn mua nh√†"
  }'

# 2. Ti·∫øp t·ª•c v·ªõi th√¥ng tin s·ªë ti·ªÅn (Step 1.1)
curl -X POST "http://localhost:8000/ai-sales-agent/process" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test_session",
    "userMessage": "500 tri·ªáu"
  }'

# 3. Ch·ªçn lo·∫°i vay (Step 1.2)
curl -X POST "http://localhost:8000/ai-sales-agent/process" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test_session", 
    "userMessage": "Th·∫ø ch·∫•p"
  }'

# 4. Th√¥ng tin c√° nh√¢n (Step 2.1)
curl -X POST "http://localhost:8000/ai-sales-agent/process" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test_session",
    "userMessage": "T√¥i t√™n Nguy·ªÖn VƒÉn A, nam, sinh nƒÉm 1990, SƒêT 0901234567"
  }'

# 5. S·ªë ng∆∞·ªùi ph·ª• thu·ªôc (Step 2.2)
curl -X POST "http://localhost:8000/ai-sales-agent/process" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test_session",
    "userMessage": "T√¥i ƒë√£ k·∫øt h√¥n v√† c√≥ 2 ng∆∞·ªùi ph·ª• thu·ªôc"
  }'

# ... Steps 3.1-5.2 (collateral, financial, debt info) ...

# 12. X√°c nh·∫≠n th√¥ng tin (Step 6)
curl -X POST "http://localhost:8000/ai-sales-agent/process" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test_session",
    "userMessage": "X√°c nh·∫≠n"
  }'

# 13. Th·∫©m ƒë·ªãnh h·ªì s∆° t·ª± ƒë·ªông (Step 7)
# ‚Üí H·ªá th·ªëng t·ª± ƒë·ªông g·ªçi /api/loan/assessment v√† tr·∫£ v·ªÅ k·∫øt qu·∫£ ƒë·∫πp m·∫Øt
```

### V√≠ d·ª• ch·ªânh s·ª≠a th√¥ng tin ·ªü Step 6

```bash
# S·ª≠a thu nh·∫≠p
curl -X POST "http://localhost:8000/ai-sales-agent/process" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test_session",
    "userMessage": "S·ª≠a thu nh·∫≠p: 35 tri·ªáu"
  }'

# S·ª≠a gi√° tr·ªã t√†i s·∫£n
curl -X POST "http://localhost:8000/ai-sales-agent/process" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test_session",
    "userMessage": "S·ª≠a t√†i s·∫£n: 1 t·ª∑"
  }'

# Sau khi s·ª≠a xong, x√°c nh·∫≠n l·∫°i
curl -X POST "http://localhost:8000/ai-sales-agent/process" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test_session",
    "userMessage": "X√°c nh·∫≠n"
  }'
```

### Streaming Chat v·ªõi file

```javascript
const eventSource = new EventSource('/chat-with-files-stream', {
  method: 'POST',
  body: JSON.stringify({
    question: "Ph√¢n t√≠ch b√°o c√°o t√†i ch√≠nh n√†y",
    files: ["base64_encoded_pdf"],
    file_names: ["financial_report.pdf"],
    session_id: "chat_123"
  })
});

eventSource.onmessage = function(event) {
  const data = JSON.parse(event.data);
  if (data.content) {
    console.log(data.content);
  }
  if (data.done) {
    eventSource.close();
  }
};
```

---

## üîÑ Backend Integration Guide

### Data Mapping cho Assessment API

Khi user x√°c nh·∫≠n th√¥ng tin ·ªü Step 6, backend c·∫ßn chu·∫©n b·ªã d·ªØ li·ªáu ƒë·ªÉ g·ªçi `/api/loan/assessment`:

```python
def prepare_assessment_data(extracted_fields: Dict[str, Any]) -> Dict[str, Any]:
    """
    Convert AI Sales Agent extracted fields to Loan Assessment API format
    """
    
    # Generate unique application ID
    application_id = f"APP_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    # Map fields with defaults
    assessment_data = {
        # Required fields
        "applicationId": application_id,
        "loanAmount": extracted_fields.get("loanAmount", 0),
        "monthlyIncome": extracted_fields.get("monthlyIncome", 0),
        
        # Loan details
        "loanTerm": extracted_fields.get("loanTerm", "15 nƒÉm"),
        "interestRate": 8.5,  # Default rate, c√≥ th·ªÉ l·∫•y t·ª´ config
        "loanPurpose": extracted_fields.get("loanPurpose", ""),
        
        # Personal info
        "fullName": extracted_fields.get("fullName", ""),
        "gender": extracted_fields.get("gender", ""),
        "birthYear": extracted_fields.get("birthYear", 0),
        "maritalStatus": extracted_fields.get("maritalStatus", ""),
        "dependents": extracted_fields.get("dependents", 0),
        
        # Contact info
        "email": extracted_fields.get("email", ""),
        "phoneNumber": extracted_fields.get("phoneNumber", ""),
        "phoneCountryCode": "+84",
        
        # Financial info
        "primaryIncomeSource": extracted_fields.get("primaryIncomeSource", ""),
        "companyName": extracted_fields.get("companyName", ""),
        "jobTitle": extracted_fields.get("jobTitle", ""),
        "workExperience": extracted_fields.get("workExperience", 0),
        "otherIncomeAmount": extracted_fields.get("otherIncomeAmount", 0),
        
        # Banking info
        "bankName": extracted_fields.get("bankName", ""),
        "bankAccount": extracted_fields.get("bankAccount", ""),
        
        # Collateral info
        "collateralType": extracted_fields.get("collateralType", ""),
        "collateralValue": extracted_fields.get("collateralValue", 0),
        "collateralDescription": extracted_fields.get("collateralInfo", ""),
        
        # Debt info
        "hasExistingDebt": extracted_fields.get("hasExistingDebt", False),
        "totalDebtAmount": extracted_fields.get("totalDebtAmount", 0),
        "monthlyDebtPayment": extracted_fields.get("monthlyDebtPayment", 0),
        "debtDetails": extracted_fields.get("debtDetails", []),
        
        # Additional info
        "additionalAssets": extracted_fields.get("additionalAssets", []),
        "monthlyExpenses": extracted_fields.get("monthlyExpenses", 0)
    }
    
    return assessment_data

# Example usage in AI Sales Agent
async def process_step_7_assessment(session_id: str, extracted_fields: Dict[str, Any]):
    """
    Process Step 7 - Call assessment API and format result
    """
    
    try:
        # 1. Prepare data for assessment API
        assessment_data = prepare_assessment_data(extracted_fields)
        
        # 2. Call assessment API
        import httpx
        async with httpx.AsyncClient() as client:
            response = await client.post(
                "http://localhost:8000/api/loan/assessment",
                json=assessment_data,
                timeout=30.0
            )
            response.raise_for_status()
            assessment_result = response.json()
        
        # 3. Format result for display
        if assessment_result["success"]:
            formatted_response = format_assessment_success(assessment_result)
        else:
            formatted_response = format_assessment_error(assessment_result)
        
        # 4. Update session with result
        session_data = {
            "currentStep": "STEP_7",
            "isCompleted": True,
            "assessmentResult": assessment_result,
            "applicationId": assessment_data["applicationId"]
        }
        
        return {
            "response": formatted_response,
            "session_data": session_data
        }
        
    except Exception as e:
        return {
            "response": f"‚ùå **L·ªñI TH·∫®M ƒê·ªäNH**\n\nH·ªá th·ªëng t·∫°m th·ªùi g·∫∑p s·ª± c·ªë: {str(e)}\n\nVui l√≤ng th·ª≠ l·∫°i sau √≠t ph√∫t.",
            "session_data": {
                "currentStep": "STEP_6",  # Back to confirmation
                "error": str(e)
            }
        }

def format_assessment_success(result: Dict[str, Any]) -> str:
    """Format successful assessment result for display"""
    
    status_emoji = {
        "APPROVED": "‚úÖ",
        "CONDITIONAL": "‚ö†Ô∏è", 
        "REJECTED": "‚ùå"
    }
    
    status_text = {
        "APPROVED": "CH·∫§P THU·∫¨N",
        "CONDITIONAL": "CH·∫§P THU·∫¨N C√ì ƒêI·ªÄU KI·ªÜN",
        "REJECTED": "T·ª™ CH·ªêI"
    }
    
    emoji = status_emoji.get(result["status"], "üìã")
    status = status_text.get(result["status"], result["status"])
    
    response = f"""üéâ **TH·∫®M ƒê·ªäNH H·ªí S∆† HO√ÄN T·∫§T**

{emoji} **K·∫æT QU·∫¢: {status}**

üìä **CHI TI·∫æT ƒê√ÅNH GI√Å:**
‚Ä¢ ƒêi·ªÉm t√≠n d·ª•ng: {result.get('creditScore', 'N/A')}/850
‚Ä¢ T·ª∑ l·ªá DTI: {result.get('debtToIncome', 0)*100:.0f}%
‚Ä¢ T·ª∑ l·ªá LTV: {result.get('loanToValue', 0)*100:.0f}%
‚Ä¢ ƒê·ªô tin c·∫≠y: {result.get('confidence', 0)*100:.0f}%

üí∞ **ƒêI·ªÄU KI·ªÜN VAY:**
‚Ä¢ S·ªë ti·ªÅn ƒë∆∞·ª£c duy·ªát: {result.get('approvedAmount', 0):,} VNƒê
‚Ä¢ L√£i su·∫•t: {result.get('interestRate', 0)}%/nƒÉm
‚Ä¢ Tr·∫£ g√≥p h√†ng th√°ng: {result.get('monthlyPayment', 0):,} VNƒê"""

    # Add conditions if any
    if result.get("conditions"):
        response += f"\n\n‚ö†Ô∏è **Y√äU C·∫¶U B·ªî SUNG:**"
        for condition in result["conditions"]:
            response += f"\n‚Ä¢ {condition}"
    
    # Add reasoning if available
    if result.get("reasoning"):
        response += f"\n\nüí° **NH·∫¨N X√âT:**\n{result['reasoning']}"
    
    response += f"\n\nüìû **B∆Ø·ªöC TI·∫æP THEO:**\nNh√¢n vi√™n t∆∞ v·∫•n s·∫Ω li√™n h·ªá trong 24h ƒë·ªÉ h∆∞·ªõng d·∫´n ho√†n thi·ªán h·ªì s∆°.\n\nM√£ h·ªì s∆°: **{result.get('applicationId', 'N/A')}**"
    
    return response
```

### Frontend Display Components

```javascript
// React component for Step 7 assessment result display
const AssessmentResult = ({ assessmentData }) => {
  const getStatusColor = (status) => {
    switch(status) {
      case 'APPROVED': return 'text-green-600';
      case 'CONDITIONAL': return 'text-yellow-600';
      case 'REJECTED': return 'text-red-600';
      default: return 'text-gray-600';
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-md p-6">
      <div className="text-center mb-6">
        <h2 className="text-2xl font-bold mb-2">üéâ Th·∫©m ƒë·ªãnh h·ªì s∆° ho√†n t·∫•t</h2>
        <div className={`text-xl font-semibold ${getStatusColor(assessmentData.status)}`}>
          {assessmentData.status === 'APPROVED' ? '‚úÖ' : 
           assessmentData.status === 'CONDITIONAL' ? '‚ö†Ô∏è' : '‚ùå'} 
          {assessmentData.status}
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        {/* Assessment Details */}
        <div className="bg-blue-50 rounded-lg p-4">
          <h3 className="font-semibold mb-3">üìä Chi ti·∫øt ƒë√°nh gi√°</h3>
          <div className="space-y-2 text-sm">
            <div>ƒêi·ªÉm t√≠n d·ª•ng: <span className="font-medium">{assessmentData.creditScore}/850</span></div>
            <div>T·ª∑ l·ªá DTI: <span className="font-medium">{(assessmentData.debtToIncome * 100).toFixed(0)}%</span></div>
            <div>T·ª∑ l·ªá LTV: <span className="font-medium">{(assessmentData.loanToValue * 100).toFixed(0)}%</span></div>
            <div>ƒê·ªô tin c·∫≠y: <span className="font-medium">{(assessmentData.confidence * 100).toFixed(0)}%</span></div>
          </div>
        </div>

        {/* Loan Terms */}
        <div className="bg-green-50 rounded-lg p-4">
          <h3 className="font-semibold mb-3">üí∞ ƒêi·ªÅu ki·ªán vay</h3>
          <div className="space-y-2 text-sm">
            <div>S·ªë ti·ªÅn duy·ªát: <span className="font-medium">{assessmentData.approvedAmount?.toLocaleString()} VNƒê</span></div>
            <div>L√£i su·∫•t: <span className="font-medium">{assessmentData.interestRate}%/nƒÉm</span></div>
            <div>Tr·∫£ g√≥p/th√°ng: <span className="font-medium">{assessmentData.monthlyPayment?.toLocaleString()} VNƒê</span></div>
          </div>
        </div>
      </div>

      {/* Conditions */}
      {assessmentData.conditions && assessmentData.conditions.length > 0 && (
        <div className="mt-6 bg-yellow-50 rounded-lg p-4">
          <h3 className="font-semibold mb-3">‚ö†Ô∏è Y√™u c·∫ßu b·ªï sung</h3>
          <ul className="space-y-1 text-sm">
            {assessmentData.conditions.map((condition, index) => (
              <li key={index}>‚Ä¢ {condition}</li>
            ))}
          </ul>
        </div>
      )}

      {/* Next Steps */}
      <div className="mt-6 bg-blue-100 rounded-lg p-4 text-center">
        <h3 className="font-semibold mb-2">üìû B∆∞·ªõc ti·∫øp theo</h3>
        <p className="text-sm">Nh√¢n vi√™n t∆∞ v·∫•n s·∫Ω li√™n h·ªá trong 24h ƒë·ªÉ h∆∞·ªõng d·∫´n ho√†n thi·ªán h·ªì s∆°.</p>
        <p className="text-xs text-gray-600 mt-2">M√£ h·ªì s∆°: <span className="font-mono">{assessmentData.applicationId}</span></p>
      </div>
    </div>
  );
};
```
